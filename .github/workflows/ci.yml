name: CI/CD Pipeline

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: Test Python Backend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8
        
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Test Python server
      run: |
        python -m pytest --cov=. --cov-report=xml || echo "No tests found, skipping"
        
    - name: Verify server starts
      run: |
        timeout 10s python opt_server.py &
        sleep 5
        curl -f http://localhost:5000/health || echo "Health check endpoint not available"

  build-extension:
    name: Build Browser Extension
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Lint JavaScript/React
      run: |
        npm run lint || echo "No lint script found"
        
    - name: Build for Chrome
      run: npm run build:chrome
      
    - name: Build for Firefox
      run: npm run build:firefox
      
    - name: Upload Chrome build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chrome-extension
        path: dist/chrome/
        retention-days: 30
        
    - name: Upload Firefox build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firefox-extension
        path: dist/firefox/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run npm audit
      run: |
        npm audit --audit-level=high || echo "Audit found issues, review required"
        
    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
      continue-on-error: true

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test-backend, build-extension, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build all browsers
      run: npm run build:all
      
    - name: Get version from package.json
      id: version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
    - name: Create ZIP archives
      run: |
        cd dist
        zip -r ../tradingview-optimizer-chrome-v${{ steps.version.outputs.version }}.zip chrome/
        zip -r ../tradingview-optimizer-firefox-v${{ steps.version.outputs.version }}.zip firefox/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        files: |
          tradingview-optimizer-chrome-v${{ steps.version.outputs.version }}.zip
          tradingview-optimizer-firefox-v${{ steps.version.outputs.version }}.zip
        body: |
          ## Changes
          - Automated release from main branch
          
          ## Installation
          1. Download the appropriate ZIP file for your browser
          2. Extract the contents
          3. Load as unpacked extension in developer mode
          
          ## Python Backend
          ```bash
          pip install -r requirements.txt
          python start_server.py
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}